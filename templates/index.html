<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lead Checklist</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 14px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h2 { margin: 0 0 14px; font-size: 18px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 0; border-top: 1px dashed #e5e7eb; }
    .row:first-child { border-top: 0; }
    .left { display: flex; align-items: center; gap: 10px; }
    input[type="checkbox"] { width: 18px; height: 18px; }
    .ts { color: #6b7280; font-size: 12px; min-width: 160px; text-align: right; }
    .btns { display: flex; gap: 10px; margin-top: 14px; }
    button { border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer; }
    .primary { background: #111827; color: #fff; }
    .danger  { background: #fee2e2; color: #b91c1c; }
    .msg { font-size: 12px; color: #10b981; margin-left: 8px; display:none; }
    .msg.error { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Lead Checklist <span id="flash" class="msg">Saved</span></h2>

    <div id="list"></div>

    <div class="btns">
      <button id="markAll" class="primary">Mark All Done</button>
      <button id="clearAll" class="danger">Clear All</button>
    </div>
  </div>

  <script>
    // Render injects these:
    const personId = {{ personId | tojson }};
    const initial  = {{ values   | tojson }};

    const fields = [
      { key: 'sentPropertyListAt',               label: 'Sent Property List' },
      { key: 'appointmentSetAt',                 label: 'Appointment Set' },
      { key: 'buyerCriteriaCollectedAt',         label: 'Buyer Criteria Collected' },
      { key: 'qualificationQuestionsCompletedAt',label: 'Qualification Questions Completed' },
    ];

    const list = document.getElementById('list');

    function fmt(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString(); // your local timezone
    }

    function flash(text, isError=false){
      const el = document.getElementById('flash');
      el.textContent = text;
      el.classList.toggle('error', !!isError);
      el.style.display = 'inline';
      setTimeout(()=> el.style.display='none', 1200);
    }

    async function saveToggle(key, check, cbEl, tsEl){
      try{
        const res = await fetch('/toggle', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ personId, key, check })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Save failed');

        // Update UI using server timestamp
        tsEl.textContent = check ? fmt(data.at) : '';
        initial[key] = check ? data.at : '';
        flash('Saved');
      }catch(err){
        // Revert checkbox on failure
        cbEl.checked = !check;
        flash(err.message || 'Error', true);
        console.error('toggle error', err);
      }
    }

    function render(){
      list.innerHTML = '';
      fields.forEach(f=>{
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="left">
            <input type="checkbox" id="cb-${f.key}">
            <span>${f.label}</span>
          </div>
          <span class="ts" id="ts-${f.key}"></span>
        `;
        list.appendChild(row);

        const cb = document.getElementById(`cb-${f.key}`);
        const ts = document.getElementById(`ts-${f.key}`);
        cb.checked = !!initial[f.key];
        ts.textContent = initial[f.key] ? fmt(initial[f.key]) : '';

        cb.addEventListener('change', e => {
          const check = e.target.checked;
          saveToggle(f.key, check, cb, ts);
        });
      });
    }

    async function bulk(state){
      for (const f of fields){
        const cb = document.getElementById(`cb-${f.key}`);
        if (cb.checked !== state){
          cb.checked = state;
          const ts = document.getElementById(`ts-${f.key}`);
          await saveToggle(f.key, state, cb, ts);
          await new Promise(r=>setTimeout(r, 60));
        }
      }
    }

    document.getElementById('markAll').onclick = () => bulk(true);
    document.getElementById('clearAll').onclick = () => bulk(false);

    render();
  </script>
</body>
</html>
